# Диагностика проблемы с HTTP соединением

## Проблема: TCP соединение устанавливается, но HTTP запрос не проходит

Если `Test-NetConnection` показывает успешное TCP соединение, но HTTP запросы не работают, проблема может быть в:

1. Сервер не обрабатывает HTTP запросы правильно
2. Проблема с keep-alive соединениями
3. Сервер закрывает соединение сразу после установки
4. Проблема с Express.js middleware

## Диагностика на сервере:

### 1. Проверьте, что сервер запущен:

```bash
# На сервере Oracle Cloud
sudo systemctl status lms-api
```

Должно быть `active (running)`.

### 2. Проверьте логи в реальном времени:

```bash
# На сервере
sudo journalctl -u lms-api -f
```

Затем попробуйте подключиться с ПК - должны появиться записи:
```
[2025-XX-XX] GET /api/health from XXX.XXX.XXX.XXX
```

### 3. Проверьте локально на сервере:

```bash
# На сервере
curl -v http://localhost:3000/api/health
```

Должен вернуться JSON ответ.

### 4. Проверьте, что сервер слушает на правильном адресе:

```bash
# На сервере
sudo ss -tlnp | grep 3000
```

Должно быть: `0.0.0.0:3000` или `*:3000`

### 5. Проверьте через telnet (с сервера):

```bash
# На сервере
telnet localhost 3000
```

Затем введите:
```
GET /api/health HTTP/1.1
Host: localhost:3000

```

Нажмите Enter дважды. Должен вернуться HTTP ответ.

### 6. Проверьте через netcat (с сервера):

```bash
# На сервере
echo -e "GET /api/health HTTP/1.1\r\nHost: localhost:3000\r\n\r\n" | nc localhost 3000
```

## Возможные решения:

### Решение 1: Перезапустить сервер

```bash
# На сервере
sudo systemctl restart lms-api
sudo systemctl status lms-api
```

### Решение 2: Проверить ошибки в логах

```bash
# На сервере
sudo journalctl -u lms-api -n 100 --no-pager | grep -i error
```

### Решение 3: Проверить, не блокирует ли что-то соединения

```bash
# На сервере
sudo netstat -an | grep 3000
```

### Решение 4: Добавить обработку keep-alive

Если проблема с keep-alive, можно добавить в `server.js`:

```javascript
// Отключить keep-alive для диагностики
app.use((req, res, next) => {
  res.set('Connection', 'close');
  next();
});
```

### Решение 5: Проверить версию Node.js

```bash
# На сервере
node --version
```

Убедитесь, что используется Node.js 18+.

## Что нужно сделать сейчас:

1. **На сервере Oracle Cloud выполните:**
   ```bash
   sudo journalctl -u lms-api -f
   ```

2. **С ПК попробуйте подключиться:**
   - Откройте браузер: `http://130.61.200.70:3000/api/health`
   - Или выполните: `Invoke-WebRequest -Uri http://130.61.200.70:3000/api/health`

3. **Проверьте логи на сервере** - должны появиться записи о запросе

4. **Если записей нет** - запросы не доходят до сервера (проблема с сетью)

5. **Если записи есть, но ответа нет** - проблема в обработке запросов на сервере

## Обновление кода:

Я добавил логирование всех запросов в `server.js`. Обновите код на сервере:

```bash
# На сервере
cd ~/lms-server
git pull
sudo systemctl restart lms-api
```

Затем проверьте логи при попытке подключения.

